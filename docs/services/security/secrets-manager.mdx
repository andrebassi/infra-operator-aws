---
title: 'Secrets Manager - Gerenciamento de Segredos'
description: 'Gerenciamento seguro de credenciais e segredos na nuvem'
icon: 'key'
---

Armazene, gerencie e rotacione segredos com segurança usando AWS Secrets Manager com criptografia KMS, rotação automática e auditoria completa.

## Pré-requisito: Configuração do AWSProvider

Antes de criar qualquer recurso AWS, você precisa configurar um **AWSProvider** que gerencia as credenciais e autenticação com a AWS.

<CodeGroup>
```yaml IRSA
apiVersion: infra.operator.aws.io/v1alpha1
kind: AWSProvider
metadata:
  name: production-aws
  namespace: default
spec:
  region: us-east-1
  roleARN: arn:aws:iam::123456789012:role/infra-operator-role
  defaultTags:
    managed-by: infra-operator
    environment: production
```

```yaml Credenciais Estáticas
apiVersion: v1
kind: Secret
metadata:
  name: aws-credentials
  namespace: default
type: Opaque
stringData:
  access-key-id: test
  secret-access-key: test
---
apiVersion: infra.operator.aws.io/v1alpha1
kind: AWSProvider
metadata:
  name: localstack
  namespace: default
spec:
  region: us-east-1
  accessKeyIDRef:
    name: aws-credentials
    key: access-key-id
  secretAccessKeyRef:
    name: aws-credentials
    key: secret-access-key
  defaultTags:
    managed-by: infra-operator
    environment: test
```

```bash Verificar Status
kubectl get awsprovider
kubectl describe awsprovider production-aws
```
</CodeGroup>

<Warning>
  Para produção, sempre use **IRSA** (IAM Roles for Service Accounts) ao invés de credenciais estáticas.
</Warning>

### Criar IAM Role para IRSA

Para usar IRSA em produção, você precisa criar uma IAM Role com as permissões necessárias:

<CodeGroup>
```json Trust Policy (trust-policy.json)
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:sub": "system:serviceaccount:infra-operator-system:infra-operator-controller-manager",
          "oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:aud": "sts.amazonaws.com"
        }
      }
    }
  ]
}
```

```json IAM Policy - Secrets Manager (secrets-policy.json)
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:CreateSecret",
        "secretsmanager:DeleteSecret",
        "secretsmanager:DescribeSecret",
        "secretsmanager:UpdateSecret",
        "secretsmanager:PutSecretValue",
        "secretsmanager:GetSecretValue",
        "secretsmanager:TagResource",
        "secretsmanager:UntagResource",
        "secretsmanager:RotateSecret",
        "secretsmanager:RestoreSecret"
      ],
      "Resource": "*"
    }
  ]
}
```

```bash Criar Role com AWS CLI
# 1. Obter OIDC Provider do cluster EKS
export CLUSTER_NAME=my-cluster
export AWS_REGION=us-east-1
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

OIDC_PROVIDER=$(aws eks describe-cluster \
  --name $CLUSTER_NAME \
  --region $AWS_REGION \
  --query "cluster.identity.oidc.issuer" \
  --output text | sed -e "s/^https:\/\///")

# 2. Atualizar trust-policy.json com valores corretos
cat > trust-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "${OIDC_PROVIDER}:sub": "system:serviceaccount:infra-operator-system:infra-operator-controller-manager",
          "${OIDC_PROVIDER}:aud": "sts.amazonaws.com"
        }
      }
    }
  ]
}
EOF

# 3. Criar IAM Role
aws iam create-role \
  --role-name infra-operator-secrets-role \
  --assume-role-policy-document file://trust-policy.json \
  --description "Role for Infra Operator Secrets Manager management"

# 4. Criar e anexar policy
aws iam put-role-policy \
  --role-name infra-operator-secrets-role \
  --policy-name SecretsManagement \
  --policy-document file://secrets-policy.json

# 5. Obter ARN da Role
aws iam get-role \
  --role-name infra-operator-secrets-role \
  --query 'Role.Arn' \
  --output text
```

```bash Anotar ServiceAccount do Operator
# Adicionar annotation ao ServiceAccount do operator
kubectl annotate serviceaccount infra-operator-controller-manager \
  -n infra-operator-system \
  eks.amazonaws.com/role-arn=arn:aws:iam::123456789012:role/infra-operator-secrets-role
```
</CodeGroup>

<Note>
  Substitua `123456789012` pelo seu AWS Account ID e `EXAMPLED539D4633E53DE1B71EXAMPLE` pelo ID do seu OIDC provider.
</Note>

## Visão Geral

AWS Secrets Manager fornece gerenciamento centralizado de segredos (credenciais, chaves de API, tokens, certificados) com:

- **Armazenamento Seguro**: Criptografia em repouso com KMS
- **Rotação Automática**: Rotate segredos sem intervenção manual
- **Controle de Acesso**: IAM policies e resource-based policies
- **Auditoria Completa**: Logging de todas as operações
- **Versionamento**: Mantém histórico de versões de segredos
- **Replicação Multi-Região**: Disaster recovery automático
- **Integração com Serviços**: RDS, Aurora, Redshift, DocumentDB
- **Recovery Window**: Janela de recuperação para deleção segura
- **Criptografia Transparente**: KMS encryption com AWS Managed ou Customer Master Key
- **Secret Attachment**: Vinculação automática com recursos AWS

**Status**: ✅ Pronto para Produção
**LocalStack**: ✅ Community

## Início Rápido

<CodeGroup>
```yaml Database Password
# Kubernetes Secret contendo o valor do segredo
apiVersion: v1
kind: Secret
metadata:
  name: db-password-source
  namespace: default
type: Opaque
stringData:
  password: "MyS3cr3tP@ssw0rd123!"

---
# Secrets Manager Secret referenciando o Kubernetes Secret
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: e2e-db-password
  namespace: default
spec:
  providerRef:
    name: localstack
  secretName: e2e/db/password
  description: "Database password for E2E testing"
  secretStringRef:
    name: db-password-source
    key: password
  tags:
    environment: test
    managed-by: infra-operator
    purpose: e2e-testing
  deletionPolicy: Delete
  recoveryWindowInDays: 7
```

```yaml API Key
# Kubernetes Secret para API key
apiVersion: v1
kind: Secret
metadata:
  name: api-key-source
  namespace: default
type: Opaque
stringData:
  apikey: "sk-1234567890abcdefghijklmnopqrstuvwxyz"

---
# Secrets Manager Secret com deleção imediata
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: e2e-api-key
  namespace: default
spec:
  providerRef:
    name: localstack
  secretName: e2e/api/key
  description: "API key for external service - E2E testing"
  secretStringRef:
    name: api-key-source
    key: apikey
  tags:
    environment: test
    managed-by: infra-operator
    service: api
    purpose: e2e-testing
  deletionPolicy: Delete
  recoveryWindowInDays: 0
```

```yaml Secret de Produção
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: db-credentials
  namespace: default
spec:
  providerRef:
    name: production-aws
  secretName: prod/database/credentials
  description: Database credentials for production
  secretString: |
    {
      "username": "admin",
      "password": "MySecurePassword123!",
      "host": "db.example.com",
      "port": 5432
    }
  kmsKeyId: alias/aws/secretsmanager
  tags:
    Environment: production
```

```bash Aplicar
kubectl apply -f secrets-manager.yaml
```

```bash Verificar
kubectl get secretsmanagersecrets
kubectl describe secretsmanagersecret db-credentials
```
</CodeGroup>

## Referência de Configuração

### Campos Obrigatórios

<ParamField path="spec.providerRef" type="object" required>
  Referência ao recurso AWSProvider

  <Expandable title="properties">
    <ParamField path="name" type="string" required>
      Nome do recurso AWSProvider
    </ParamField>
  </Expandable>
</ParamField>

<ParamField path="spec.secretName" type="string" required>
  Nome do segredo na AWS Secrets Manager. Use namespacing com `/` para organização.

  **Exemplos:**
  - `prod/database/credentials`
  - `dev/api/keys`
  - `staging/third-party/webhooks`

  **Regras:**
  - Máximo 512 caracteres
  - Suporta caracteres: A-Z a-z 0-9 /_+=.@-
  - Case-sensitive
</ParamField>

<ParamField path="spec.secretString" type="string">
  String do segredo (texto simples ou JSON). Máximo 65536 caracteres.

  **Exemplo JSON:**
  ```json
  {
    "username": "admin",
    "password": "secure-password",
    "host": "db.example.com",
    "port": 5432
  }
  ```

  **Nota:** Use `secretString` para texto ou `secretBinary` para dados binários (base64).
</ParamField>

### Campos Opcionais

<ParamField path="spec.description" type="string">
  Descrição clara do propósito do segredo

  **Exemplos:**
  - "Database credentials for production PostgreSQL"
  - "API keys for third-party payment service"
  - "SSL certificate for domain.com"
</ParamField>

<ParamField path="spec.secretBinary" type="string">
  Dados binários em base64 (alternativa a secretString)

  ```yaml
  secretBinary: aGVsbG8gd29ybGQgYmluYXJ5IGRhdGE=
  ```
</ParamField>

<ParamField path="spec.kmsKeyId" type="string">
  ID da chave KMS para criptografia. Se não fornecida, usa AWS Managed Key.

  **Formatos aceitos:**
  - ARN: `arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012`
  - Key ID: `12345678-1234-1234-1234-123456789012`
  - Alias: `alias/my-key`
  - Alias especial: `alias/aws/secretsmanager` (padrão)

  **Recomendação:** Usar chave KMS customer-managed para compliance
</ParamField>

<ParamField path="spec.rotationEnabled" type="boolean" default="false">
  Se `true`, habilita rotação automática do segredo

  **Detalhes:**
  - Requer `rotationLambdaArn` e `rotationSchedule`
  - Lambda função rotaciona o segredo automaticamente
  - Cria nova versão do segredo a cada rotação
</ParamField>

<ParamField path="spec.rotationLambdaArn" type="string">
  ARN da função Lambda que rotaciona o segredo

  **Exemplo:**
  ```
  arn:aws:lambda:us-east-1:123456789012:function:rotate-secret
  ```

  **Obrigatório se:** `rotationEnabled: true`
</ParamField>

<ParamField path="spec.rotationSchedule" type="object">
  Configuração de agendamento de rotação

  ```yaml
  rotationSchedule:
    automaticallyAfterDays: 30
    duration: 3  # horas
  ```

  **Campos:**
  - `automaticallyAfterDays`: Rotacionar a cada N dias (30-180)
  - `duration`: Horas permitidas para completar rotação
</ParamField>

<ParamField path="spec.replicaRegions" type="array">
  Replicar segredo em múltiplas regiões para disaster recovery

  ```yaml
  replicaRegions:
  - region: us-west-2
    kmsKeyId: arn:aws:kms:us-west-2:123456789012:key/...
  - region: eu-west-1
    kmsKeyId: arn:aws:kms:eu-west-1:123456789012:key/...
  ```
</ParamField>

<ParamField path="spec.tags" type="object">
  Pares chave-valor para organização e controle de acesso

  ```yaml
  tags:
    Environment: production
    Application: myapp
    Team: platform
    CostCenter: engineering
    Compliance: pci-dss
  ```
</ParamField>

<ParamField path="spec.recoveryWindowInDays" type="integer" default="30">
  Dias para janela de recuperação antes de deletar segredo (7-30 dias)

  **Detalhes:**
  - Durante este período, segredo pode ser recuperado
  - Após período, deleção é permanente
  - Padrão: 30 dias (máxima proteção)
</ParamField>

<ParamField path="spec.deletionPolicy" type="string" default="ScheduleDeletion">
  O que acontece com o segredo quando o CR é deletado

  **Opções:**
  - `ScheduleDeletion`: Agenda deleção com recovery window (padrão, seguro)
  - `Delete`: Deleta imediatamente
  - `Retain`: Mantém segredo na AWS mas sem gerenciamento
</ParamField>

## Campos de Status

Após o segredo ser criado, os seguintes campos de status são populados:

<ResponseField name="status.secretArn" type="string">
  ARN completo do segredo (ex: `arn:aws:secretsmanager:us-east-1:123456789012:secret:prod/database/credentials-abc123`)
</ResponseField>

<ResponseField name="status.versionId" type="string">
  ID da versão atual do segredo
</ResponseField>

<ResponseField name="status.rotationEnabled" type="boolean">
  Se a rotação automática está habilitada
</ResponseField>

<ResponseField name="status.lastRotatedDate" type="string">
  Data da última rotação (ISO 8601)
</ResponseField>

<ResponseField name="status.nextRotationDate" type="string">
  Data agendada para próxima rotação
</ResponseField>

<ResponseField name="status.ready" type="boolean">
  `true` quando o segredo está criado e pronto para uso
</ResponseField>

<ResponseField name="status.lastSyncTime" type="string">
  Timestamp da última sincronização com AWS
</ResponseField>

## Exemplos

### Credenciais de Database (JSON)

Secret com credenciais de banco de dados em formato JSON:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: prod-postgres-credentials
  namespace: default
spec:
  providerRef:
    name: production-aws

  secretName: prod/database/postgresql/credentials

  description: PostgreSQL database credentials for production environment

  # Credenciais em formato JSON
  secretString: |
    {
      "username": "postgres_admin",
      "password": "Tr0picálC0l0rsSecure!@#2025",
      "host": "prod-db.example.com",
      "port": 5432,
      "dbname": "production_db",
      "engine": "postgresql"
    }

  # Usar chave KMS customer-managed
  kmsKeyId: arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012

  tags:
    Environment: production
    Application: main-app
    Team: database
    Compliance: sox-compliant

  recoveryWindowInDays: 30
```

### API Keys e Tokens

Secret com múltiplas chaves de API:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: api-keys
  namespace: default
spec:
  providerRef:
    name: production-aws

  secretName: prod/api/third-party-keys

  description: Third-party API keys for payment and notification services

  secretString: |
    {
      "stripe_api_key": "sk_live_abc123def456ghi789jkl",
      "stripe_webhook_secret": "whsec_abc123def456",
      "sendgrid_api_key": "SG.abc123def456",
      "github_token": "ghp_abc123def456",
      "slack_webhook": "https://hooks.slack.com/services/..."
    }

  kmsKeyId: alias/aws/secretsmanager

  tags:
    Environment: production
    Type: api-keys
    Owner: platform-team
```

### Certificados SSL/TLS

Secret para armazenar certificado e chave privada:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: ssl-certificate
  namespace: default
spec:
  providerRef:
    name: production-aws

  secretName: prod/certificates/domain-com

  description: SSL/TLS certificate and private key for domain.com

  secretString: |
    {
      "certificate": "-----BEGIN CERTIFICATE-----\nMIID...\n-----END CERTIFICATE-----",
      "private_key": "-----BEGIN PRIVATE KEY-----\nMIIE...\n-----END PRIVATE KEY-----",
      "certificate_chain": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
      "expiration_date": "2026-12-31"
    }

  kmsKeyId: arn:aws:kms:us-east-1:123456789012:key/cert-key-id

  tags:
    Environment: production
    Domain: domain.com
    Type: ssl-certificate
    ExpiryDate: "2026-12-31"
```

### Secret com Rotation Automática

Secret configurado com Lambda para rotação automática:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: rotating-password
  namespace: default
spec:
  providerRef:
    name: production-aws

  secretName: prod/database/rotating/password

  description: Database password rotated automatically monthly

  secretString: |
    {
      "username": "app_user",
      "password": "CurrentPassword2025!@#"
    }

  # KMS encryption
  kmsKeyId: arn:aws:kms:us-east-1:123456789012:key/rotation-key

  # Habilitar rotação automática
  rotationEnabled: true

  # Lambda que rotaciona o segredo
  rotationLambdaArn: arn:aws:lambda:us-east-1:123456789012:function:rds-password-rotator

  # Agendamento de rotação
  rotationSchedule:
    automaticallyAfterDays: 30  # Rotacionar a cada 30 dias
    duration: 3  # Completer em até 3 horas
    scheduleExpression: "rate(30 days)"

  tags:
    Environment: production
    Rotation: monthly
    Type: database-password
```

### Secret Replicado em Multi-Região

Secret replicado para disaster recovery:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: global-secret
  namespace: default
spec:
  providerRef:
    name: production-aws

  secretName: prod/global/app-master-key

  description: Application master encryption key replicated globally

  secretString: |
    {
      "master_key": "85ecf8c5-ac6c-4ab2-b1f0-7cd3c7e8a9b0",
      "key_version": "1"
    }

  kmsKeyId: arn:aws:kms:us-east-1:123456789012:key/primary-key

  # Replicar em múltiplas regiões
  replicaRegions:
  - region: us-west-2
    kmsKeyId: arn:aws:kms:us-west-2:123456789012:key/west-key
  - region: eu-west-1
    kmsKeyId: arn:aws:kms:eu-west-1:123456789012:key/eu-key

  tags:
    Environment: production
    HA: enabled
    ReplicationEnabled: "true"
```

## Verificação

### Verificar Status via kubectl

```bash
# Listar todos os segredos
kubectl get secretsmanagersecrets

# Obter informações detalhadas
kubectl get secretsmanagersecret db-credentials -o yaml

# Descrever secret com eventos
kubectl describe secretsmanagersecret db-credentials

# Acompanhar criação em tempo real
kubectl get secretsmanagersecret db-credentials -w

# Ver apenas status
kubectl get secretsmanagersecret db-credentials -o jsonpath='{.status}'
```

### Verificar na AWS

<Tabs>
  <Tab title="AWS CLI">
    ```bash
    # Listar segredos
    aws secretsmanager list-secrets --region us-east-1

    # Obter detalhes do segredo
    aws secretsmanager describe-secret \
      --secret-id prod/database/credentials \
      --region us-east-1 \
      --output json | jq '.'

    # Recuperar valor do segredo
    aws secretsmanager get-secret-value \
      --secret-id prod/database/credentials \
      --region us-east-1

    # Ver versões do segredo
    aws secretsmanager list-secret-version-ids \
      --secret-id prod/database/credentials \
      --region us-east-1

    # Ver configuração de rotação
    aws secretsmanager describe-secret \
      --secret-id prod/database/credentials \
      --query 'RotationRules'

    # Ver replicação de segredo
    aws secretsmanager describe-secret \
      --secret-id prod/database/credentials \
      --query 'AddedToRegionDate,ReplicationStatus'

    # Testar acesso ao segredo
    aws secretsmanager get-secret-value \
      --secret-id prod/database/credentials \
      --version-id <version-id>
    ```
  </Tab>

  <Tab title="LocalStack">
    ```bash
    # Apontar para LocalStack
    export AWS_ENDPOINT_URL=http://localhost:4566

    # Listar segredos
    aws secretsmanager list-secrets

    # Descrever segredo
    aws secretsmanager describe-secret \
      --secret-id prod/database/credentials

    # Recuperar valor
    aws secretsmanager get-secret-value \
      --secret-id prod/database/credentials
    ```
  </Tab>
</Tabs>

### Saída Esperada

```yaml
status:
  secretArn: arn:aws:secretsmanager:us-east-1:123456789012:secret:prod/database/credentials-abc123
  versionId: a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6
  rotationEnabled: true
  lastRotatedDate: "2025-11-22T20:18:08Z"
  nextRotationDate: "2025-12-22T20:18:08Z"
  ready: true
  lastSyncTime: "2025-11-22T20:18:08Z"
```

## Resolução de Problemas

<AccordionGroup>
  <Accordion title="Secret não rotaciona automaticamente">
    **Sintomas:** `lastRotatedDate` não muda, rotation não executa

    **Causas comuns:**
    1. `rotationEnabled: false` (padrão desabilitado)
    2. Lambda ARN inválida ou permissões insuficientes
    3. Lambda função tem erro ao executar

    **Soluções:**
    ```bash
    # Verificar configuração de rotação
    kubectl get secretsmanagersecret rotating-password -o yaml | grep -A 5 rotation

    # Ver status de rotação na AWS
    aws secretsmanager describe-secret \
      --secret-id prod/database/rotating/password \
      --query 'RotationRules'

    # Verificar logs da Lambda
    aws logs tail /aws/lambda/rds-password-rotator --follow

    # Verificar eventos da rotação
    aws secretsmanager get-secret-value \
      --secret-id prod/database/rotating/password \
      --query 'VersionIdsToStages'

    # Forçar rotação manual
    aws secretsmanager rotate-secret \
      --secret-id prod/database/rotating/password \
      --rotation-lambda-arn arn:aws:lambda:us-east-1:123456789012:function:rotator

    # Verificar permission da Lambda
    aws secretsmanager describe-secret \
      --secret-id prod/database/rotating/password \
      --query 'RotationEnabled,RotationLambdaARN,RotationRules'
    ```
  </Accordion>

  <Accordion title="Access denied ao ler secret">
    **Erro:** `AccessDeniedException` ou `UserNotAuthorizedForSecretException`

    **Causas:**
    1. IAM policy não permite `secretsmanager:GetSecretValue`
    2. Resource-based policy do secret bloqueia acesso
    3. KMS key policy não permite decrypt

    **Soluções:**
    ```bash
    # Verificar permissões IAM
    aws iam get-user-policy --user-name <user> --policy-name <policy>

    # Verificar policy do secret (se configurada)
    aws secretsmanager get-resource-policy \
      --secret-id prod/database/credentials

    # Verificar permissões KMS
    aws kms describe-key --key-id <kms-key-id> \
      --query 'KeyMetadata.KeyState'

    # Adicionar permissão IAM
    aws iam put-user-policy --user-name <user> \
      --policy-name secretsmanager-access \
      --policy-document file://policy.json
    ```

    **Exemplo policy.json:**
    ```json
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Action": [
          "secretsmanager:GetSecretValue",
          "secretsmanager:DescribeSecret"
        ],
        "Resource": "arn:aws:secretsmanager:*:123456789012:secret:prod/*"
      }, {
        "Effect": "Allow",
        "Action": [
          "kms:Decrypt",
          "kms:DescribeKey"
        ],
        "Resource": "arn:aws:kms:*:123456789012:key/*"
      }]
    }
    ```
  </Accordion>

  <Accordion title="Lambda falha ao rotacionar">
    **Sintomas:** Rotação agendada falha, Lambda produz erro

    **Causas:**
    1. Lambda não tem permissão de atualizar secret
    2. Lambda não consegue conectar ao banco de dados
    3. Função não consegue se autenticar na AWS

    **Soluções:**
    ```bash
    # Verificar logs da Lambda
    aws logs tail /aws/lambda/rds-password-rotator --follow

    # Ver detalhes do erro
    aws secretsmanager describe-secret \
      --secret-id prod/database/rotating/password \
      --query 'LastFailedDate,LastFailedSyncErrorCode'

    # Verificar IAM role da Lambda
    aws iam get-role --role-name lambda-rotation-role

    # Adicionar permissões necessárias
    aws iam attach-role-policy \
      --role-name lambda-rotation-role \
      --policy-arn arn:aws:iam::aws:policy/SecretsManagerReadWrite

    # Testar rotação manualmente
    aws secretsmanager rotate-secret \
      --secret-id prod/database/rotating/password \
      --rotation-lambda-arn arn:aws:lambda:us-east-1:123456789012:function:rotator
    ```
  </Accordion>

  <Accordion title="Replicação de secret não funciona">
    **Sintomas:** Secret não aparece em regiões replicadas, replication status erro

    **Causas:**
    1. KMS keys em regiões réplicas não existem ou sem permissão
    2. Regiões não suportadas
    3. Limite de replicação atingido

    **Soluções:**
    ```bash
    # Verificar status de replicação
    aws secretsmanager describe-secret \
      --secret-id prod/global/app-master-key \
      --region us-east-1 \
      --query 'ReplicationStatus'

    # Verificar chaves KMS nas regiões réplicas
    aws kms list-keys --region us-west-2
    aws kms list-keys --region eu-west-1

    # Verificar permissões nas regiões réplicas
    aws kms describe-key \
      --key-id <kms-key-id> \
      --region us-west-2

    # Se erro, criar segredo replica manualmente
    aws secretsmanager replicate-secret-to-regions \
      --secret-id prod/global/app-master-key \
      --add-replica-regions Region=us-west-2,KmsKeyId=<key-id>
    ```
  </Accordion>

  <Accordion title="Custos elevados (secret tem múltiplas versões)">
    **Sintomas:** Cobranças inesperadas, muitas versões acumuladas

    **Causa:** Muitas versões do secret criadas por rotações contínuas

    **Soluções:**
    ```bash
    # Ver versões do secret
    aws secretsmanager list-secret-version-ids \
      --secret-id prod/database/credentials

    # Deletar versões antigas (manualmente)
    aws secretsmanager delete-secret \
      --secret-id prod/database/credentials \
      --version-id <old-version-id>

    # Ou usar retention policy para auto-cleanup
    # (nota: Secrets Manager mantém apenas versões de staging atual)

    # Limitar rotações (aumentar dias entre rotações)
    kubectl patch secretsmanagersecret rotating-password \
      --type merge \
      -p '{"spec":{"rotationSchedule":{"automaticallyAfterDays":90}}}'
    ```
  </Accordion>

  <Accordion title="Segredo não aparece depois de criar CR">
    **Sintomas:** `ready: false`, secret não aparece na AWS

    **Causas:**
    1. AWSProvider não configurado ou não Ready
    2. Permissão insuficiente (CreateSecret)
    3. Nome do segredo já existe em outra conta

    **Soluções:**
    ```bash
    # Verificar status do AWSProvider
    kubectl describe awsprovider production-aws

    # Ver logs do operator
    kubectl logs -n infra-operator-system \
      deploy/infra-operator-controller-manager \
      --tail=100 | grep -i secret

    # Verificar se segredo existe na AWS
    aws secretsmanager describe-secret \
      --secret-id prod/database/credentials 2>&1

    # Verificar eventos do CR
    kubectl describe secretsmanagersecret db-credentials

    # Tentar forçar sincronização
    kubectl annotate secretsmanagersecret db-credentials \
      force-sync="$(date +%s)" --overwrite
    ```
  </Accordion>

  <Accordion title="Não consegue deletar secret (em deleção programada)">
    **Sintomas:** Secret fica em "PendingDeletion" indefinidamente

    **Causa:** Recovery window ainda não expirou

    **Soluções:**
    ```bash
    # Ver data agendada de deleção
    aws secretsmanager describe-secret \
      --secret-id prod/database/credentials \
      --query 'DeletedDate'

    # Cancelar deleção se mudou ideia
    aws secretsmanager restore-secret \
      --secret-id prod/database/credentials

    # Forçar deleção imediata
    aws secretsmanager delete-secret \
      --secret-id prod/database/credentials \
      --force-delete-without-recovery

    # Via kubectl (usar deletionPolicy: Delete)
    kubectl patch secretsmanagersecret db-credentials \
      --type merge \
      -p '{"spec":{"deletionPolicy":"Delete"}}'
    ```
  </Accordion>
</AccordionGroup>

## Melhores Práticas

<CardGroup cols={2}>
  <Card title="Sempre usar KMS Encryption" icon="lock">
    - Use chave KMS customer-managed em produção
    - Padrão `alias/aws/secretsmanager` é seguro mas gerenciado pela AWS
    - Permite auditoria granular via CloudTrail
    - Possibilita denegação de acesso revogando chave
  </Card>

  <Card title="Rotation Automática" icon="rotate">
    - Habilitar `rotationEnabled: true` para credenciais
    - Rotar a cada 30-90 dias (ajustar conforme compliance)
    - Lambda deve poder atualizar credencial no serviço
    - Monitorar falhas de rotação no CloudWatch
  </Card>

  <Card title="Least Privilege Access" icon="shield-halved">
    - IAM policies específicas por application
    - Resource-based policies para controle granular
    - Usar Secrets Manager tags para RBAC
    - Revisar policies regularmente
  </Card>

  <Card title="Versionamento e Recovery" icon="history">
    - `recoveryWindowInDays: 30` para máxima proteção
    - Versões antigas mantêm histórico de rotações
    - Permite rollback se rotação quebrou algo
    - Compliance geralmente exige recovery window
  </Card>

  <Card title="Replicação Multi-Região" icon="globe">
    - Usar `replicaRegions` para DR crítico
    - Segredos replicados automaticamente
    - Custo: $0.40/mês por segredo replicado
    - Essencial para aplicações globais
  </Card>

  <Card title="Tagging e Organização" icon="tags">
    - Tag por `Environment` (prod/dev/staging)
    - Inclua `Application` e `Owner`
    - Use `Compliance` para requisitos (sox, pci)
    - Facilita rastreamento e compliance
  </Card>

  <Card title="Auditoria e Logging" icon="list">
    - Logging registra GetSecretValue, UpdateSecret, etc
    - Revisar logs regularmente
    - Manter por período de compliance
    - Configurar alertas para acessos
  </Card>

  <Card title="Never Log Secrets" icon="ban">
    - Nunca logar valor do segredo em aplicação
    - Não commitar segredos no Git
    - Usar `***` em logs ao invés de valor
    - Mascarar segredos em stderr/stdout
  </Card>

  <Card title="Integração com RDS" icon="database">
    - RDS puede auto-rotate database passwords
    - Usar attachment automático
    - Lambda maneja rotación transparente
    - Permite zero-downtime password rotation
  </Card>

  <Card title="Monitoramento de Custos" icon="dollar-sign">
    - ~$0.40/mês por secret armazenado
    - Replicação multiplica por número de regiões
    - Deletar secrets não utilizados
    - AlertPlus para custos anormais
  </Card>
</CardGroup>

## Padrões de Arquitetura

### Padrão: Integração com RDS

Secrets Manager com rotação automática integrada com RDS:

```yaml
# 1. Criar secret com credenciais RDS
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: rds-auto-rotate
spec:
  providerRef:
    name: production-aws

  secretName: prod/rds/postgres/password

  description: PostgreSQL password rotated by RDS integration

  secretString: |
    {
      "username": "postgres",
      "password": "InitialPassword123!@#"
    }

  kmsKeyId: arn:aws:kms:us-east-1:123456789012:key/rds-key

  # Rotação automática via Lambda
  rotationEnabled: true
  rotationLambdaArn: arn:aws:lambda:us-east-1:123456789012:function:SecretsManager-postgres-rotate
  rotationSchedule:
    automaticallyAfterDays: 30

---
# 2. RDS usa este secret para credenciais
# (Configurado via console ou IaC do RDS)
```

### Padrão: Secrets por Aplicação

Organizar secrets por aplicação com namespacing:

```yaml
---
# App A: Database
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: app-a-db
spec:
  secretName: prod/app-a/database/credentials
  secretString: |
    {
      "host": "db-a.example.com",
      "username": "app_a_user"
    }
  tags:
    Application: app-a

---
# App A: API Keys
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: app-a-api-keys
spec:
  secretName: prod/app-a/api/keys
  secretString: |
    {
      "stripe_key": "sk_live_..."
    }
  tags:
    Application: app-a

---
# App B: Database
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: app-b-db
spec:
  secretName: prod/app-b/database/credentials
  tags:
    Application: app-b
```

### Padrão: Secrets com Multi-Region HA

Configuração global com replicação:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: global-master-key
spec:
  providerRef:
    name: production-aws

  secretName: prod/global/encryption-key

  secretString: |
    {
      "master_key": "key-value-here"
    }

  # Replicação automática
  replicaRegions:
  - region: us-west-2
    kmsKeyId: arn:aws:kms:us-west-2:123456789012:key/west
  - region: eu-west-1
    kmsKeyId: arn:aws:kms:eu-west-1:123456789012:key/eu
  - region: ap-southeast-1
    kmsKeyId: arn:aws:kms:ap-southeast-1:123456789012:key/ap

  tags:
    HA: enabled
    GlobalReplication: "true"
```

## Integração com Serviços

### RDS Password Rotation

RDS suporta rotação automática de senha via Lambda:

```bash
# AWS cria automaticamente função Lambda para RDS rotation
# Secret deve estar no formato:
# {"username": "...", "password": "..."}

# Configurar secret para RDS (via AWS Console ou CLI)
aws secretsmanager put-secret-attachments \
  --secret-id prod/rds/postgres/password \
  --secret-binary arn:aws:rds:<region>:account:db:instance-name
```

### Kubernetes ExternalSecrets Operator

Usar External Secrets Operator para sincronizar com Kubernetes:

```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-store
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-store
    kind: SecretStore
  target:
    name: db-credentials
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: prod/database/credentials
      property: username
  - secretKey: password
    remoteRef:
      key: prod/database/credentials
      property: password
```

## Casos de Uso

### 1. Credenciais de Database

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: prod-postgres
spec:
  secretName: prod/postgres/admin
  secretString: |
    {
      "host": "prod-db.example.com",
      "port": 5432,
      "username": "admin",
      "password": "SecurePassword123!"
    }
```

### 2. API Keys Terceiros

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: stripe-keys
spec:
  secretName: prod/stripe/api-keys
  secretString: |
    {
      "public_key": "pk_live_...",
      "secret_key": "sk_live_..."
    }
```

### 3. Certificados SSL/TLS

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: tls-cert
spec:
  secretName: prod/tls/domain-com
  secretString: |
    {
      "certificate": "-----BEGIN CERTIFICATE-----...",
      "private_key": "-----BEGIN PRIVATE KEY-----...",
      "expiration": "2026-12-31"
    }
```

## Comparação com Alternativas

| Aspecto | Secrets Manager | Parameter Store | Kubernetes Secrets |
|--------|-----------------|-----------------|-------------------|
| **Criptografia** | KMS obrigatória | KMS opcional | Apenas base64 |
| **Rotação** | Automática via Lambda | Manual | Manual |
| **Versionamento** | Automático | Sem versioning | Sem versioning |
| **Auditoria** | CloudTrail completo | CloudTrail básico | Logs do etcd |
| **Custo** | $0.40/mês por secret | Free até 100 | Free (cluster) |
| **Replicação** | Multi-region automático | Manual | Manual |
| **Compliance** | SOC2, PCI-DSS ready | Limitado | Limitado |

## Recursos Relacionados

<CardGroup cols={2}>
  <Card
    title="KMS Key"
    icon="lock"
    href="/services/security/kms"
  >
    Criptografia de segredos com KMS
  </Card>

  <Card
    title="IAM"
    icon="user-shield"
    href="/services/security/iam"
  >
    Controle de acesso aos segredos
  </Card>

  <Card
    title="RDS"
    icon="database"
    href="/services/database/rds"
  >
    Rotação automática de senhas RDS
  </Card>

  <Card
    title="Lambda"
    icon="function"
    href="/services/compute/lambda"
  >
    Função de rotação de segredos
  </Card>
</CardGroup>

---
