---
title: 'IAM Role - Gerenciamento de Acesso'
description: 'Crie e gerencie roles IAM com políticas de acesso'
icon: 'user-shield'
---

Gerencie identidades e permissões de acesso para recursos AWS diretamente do Kubernetes.

## Pré-requisito: Configuração do AWSProvider

Antes de criar qualquer recurso AWS, você precisa configurar um **AWSProvider** que gerencia as credenciais e autenticação com a AWS.

<CodeGroup>
```yaml IRSA
apiVersion: infra.operator.aws.io/v1alpha1
kind: AWSProvider
metadata:
  name: production-aws
  namespace: default
spec:
  region: us-east-1
  roleARN: arn:aws:iam::123456789012:role/infra-operator-role
  defaultTags:
    managed-by: infra-operator
    environment: production
```

```yaml Credenciais Estáticas
apiVersion: v1
kind: Secret
metadata:
  name: aws-credentials
  namespace: default
type: Opaque
stringData:
  access-key-id: test
  secret-access-key: test
---
apiVersion: infra.operator.aws.io/v1alpha1
kind: AWSProvider
metadata:
  name: localstack
  namespace: default
spec:
  region: us-east-1
  accessKeyIDRef:
    name: aws-credentials
    key: access-key-id
  secretAccessKeyRef:
    name: aws-credentials
    key: secret-access-key
  defaultTags:
    managed-by: infra-operator
    environment: test
```

```bash Verificar Status
kubectl get awsprovider
kubectl describe awsprovider production-aws
```
</CodeGroup>

<Warning>
  Para produção, sempre use **IRSA** (IAM Roles for Service Accounts) ao invés de credenciais estáticas.
</Warning>

### Criar IAM Role para IRSA

Para usar IRSA em produção, você precisa criar uma IAM Role com as permissões necessárias:

<CodeGroup>
```json Trust Policy (trust-policy.json)
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:sub": "system:serviceaccount:infra-operator-system:infra-operator-controller-manager",
          "oidc.eks.us-east-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:aud": "sts.amazonaws.com"
        }
      }
    }
  ]
}
```

```json IAM Policy - IAM Role Management (iam-policy.json)
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iam:CreateRole",
        "iam:DeleteRole",
        "iam:GetRole",
        "iam:UpdateRole",
        "iam:AttachRolePolicy",
        "iam:DetachRolePolicy",
        "iam:PutRolePolicy",
        "iam:DeleteRolePolicy",
        "iam:GetRolePolicy",
        "iam:ListRolePolicies",
        "iam:ListAttachedRolePolicies",
        "iam:TagRole",
        "iam:UntagRole",
        "iam:ListRoleTags"
      ],
      "Resource": "*"
    }
  ]
}
```

```bash Criar Role com AWS CLI
# 1. Obter OIDC Provider do cluster EKS
export CLUSTER_NAME=my-cluster
export AWS_REGION=us-east-1
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

OIDC_PROVIDER=$(aws eks describe-cluster \
  --name $CLUSTER_NAME \
  --region $AWS_REGION \
  --query "cluster.identity.oidc.issuer" \
  --output text | sed -e "s/^https:\/\///")

# 2. Atualizar trust-policy.json com valores corretos
cat > trust-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "${OIDC_PROVIDER}:sub": "system:serviceaccount:infra-operator-system:infra-operator-controller-manager",
          "${OIDC_PROVIDER}:aud": "sts.amazonaws.com"
        }
      }
    }
  ]
}
EOF

# 3. Criar IAM Role
aws iam create-role \
  --role-name infra-operator-iam-role \
  --assume-role-policy-document file://trust-policy.json \
  --description "Role for Infra Operator IAM management"

# 4. Criar e anexar policy
aws iam put-role-policy \
  --role-name infra-operator-iam-role \
  --policy-name IAMManagement \
  --policy-document file://iam-policy.json

# 5. Obter ARN da Role
aws iam get-role \
  --role-name infra-operator-iam-role \
  --query 'Role.Arn' \
  --output text
```

```bash Anotar ServiceAccount do Operator
# Adicionar annotation ao ServiceAccount do operator
kubectl annotate serviceaccount infra-operator-controller-manager \
  -n infra-operator-system \
  eks.amazonaws.com/role-arn=arn:aws:iam::123456789012:role/infra-operator-iam-role
```
</CodeGroup>

<Note>
  Substitua `123456789012` pelo seu AWS Account ID e `EXAMPLED539D4633E53DE1B71EXAMPLE` pelo ID do seu OIDC provider.
</Note>

## Visão Geral

IAM Roles no Infra Operator permitem criar e gerenciar funções de acesso (roles) e suas políticas associadas. As roles definem quem pode acessar quais recursos AWS, com que permissões e em que condições. Elas são essenciais para implementar o princípio de menor privilégio (Least Privilege) e garantir segurança em sua infraestrutura.

### Conceitos Principais

- **IAM Role**: Entidade que define permissões de acesso
- **Trust Relationship (AssumeRolePolicyDocument)**: Define quem pode usar a role
- **Managed Policies**: Políticas pré-definidas pela AWS ou customizadas
- **Inline Policies**: Políticas específicas incorporadas na role
- **Permissions Boundary**: Limite máximo de permissões que a role pode ter
- **Service-Linked Roles**: Roles automáticas para serviços específicos

## Início Rápido

<CodeGroup>
```yaml EC2 Service Role
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: e2e-ec2-role
  namespace: default
spec:
  providerRef:
    name: localstack
  roleName: e2e-ec2-service-role
  description: "IAM role for EC2 instances - E2E testing"
  path: /e2e/
  maxSessionDuration: 3600

  # Quem pode assumir essa role (Trust Relationship)
  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "ec2.amazonaws.com"
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }

  # Políticas gerenciadas pela AWS
  managedPolicyArns:
  - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
  - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  tags:
    environment: test
    managed-by: infra-operator
    purpose: e2e-testing

  deletionPolicy: Delete
```

```yaml Lambda com Inline Policy
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: e2e-lambda-role
  namespace: default
spec:
  providerRef:
    name: localstack
  roleName: e2e-lambda-execution-role
  description: "Lambda execution role with custom inline policy - E2E testing"
  path: /lambda/
  maxSessionDuration: 7200

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "lambda.amazonaws.com"
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Política inline customizada
  inlinePolicy:
    policyName: CustomDynamoDBAccess
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "dynamodb:GetItem",
              "dynamodb:PutItem",
              "dynamodb:UpdateItem",
              "dynamodb:Query"
            ],
            "Resource": "arn:aws:dynamodb:*:*:table/e2e-*"
          }
        ]
      }

  tags:
    environment: test
    managed-by: infra-operator
    service: lambda
    purpose: e2e-testing

  deletionPolicy: Delete
```

```yaml Role de Produção
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: lambda-execution-role
  namespace: default
spec:
  providerRef:
    name: production-aws
  roleName: lambda-execution-role
  description: "Role para execução de funções Lambda"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "lambda.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  tags:
    Environment: production
    Application: my-app

  deletionPolicy: Retain
```

```bash Aplicar
kubectl apply -f iam-role.yaml
```

```bash Verificar
kubectl get iamroles
kubectl describe iamrole lambda-execution-role
kubectl get iamrole lambda-execution-role -o jsonpath='{.status.roleArn}'
```
</CodeGroup>

## Configuração

### Campos Obrigatórios

| Campo | Descrição | Exemplo |
|-------|-----------|---------|
| `providerRef.name` | Nome do AWSProvider configurado | `production-aws` |
| `roleName` | Nome da role no AWS IAM | `lambda-execution-role` |
| `assumeRolePolicyDocument` | Documento JSON que define quem pode assumir a role | JSON policy document |

### Campos Opcionais

| Campo | Descrição | Padrão |
|-------|-----------|--------|
| `description` | Descrição legível da role | "" |
| `path` | Caminho da role no IAM (/service-role/, /custom/, etc) | "/" |
| `managedPolicyArns` | Lista de ARNs de políticas gerenciadas | [] |
| `inlinePolicies` | Políticas inline incorporadas na role | [] |
| `maxSessionDuration` | Duração máxima da sessão em segundos | 3600 |
| `permissionsBoundary` | ARN da policy que limita as permissões | "" |
| `tags` | Tags para categorização e governança | {} |

### Exemplo Completo

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: application-service-role
  namespace: default
spec:
  providerRef:
    name: production-aws

  roleName: application-service-role
  description: "Role para acesso a recursos de armazenamento e banco de dados"
  path: /service-roles/

  # Defina a trust relationship
  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {"Service": "ec2.amazonaws.com"},
          "Action": "sts:AssumeRole"
        },
        {
          "Effect": "Allow",
          "Principal": {"AWS": "arn:aws:iam::123456789012:role/other-role"},
          "Action": "sts:AssumeRole",
          "Condition": {"StringEquals": {"sts:ExternalId": "unique-external-id"}}
        }
      ]
    }

  # Políticas gerenciadas
  managedPolicyArns:
  - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
  - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess

  # Políticas inline customizadas
  inlinePolicies:
  - policyName: dynamodb-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "dynamodb:GetItem",
              "dynamodb:PutItem",
              "dynamodb:UpdateItem",
              "dynamodb:Query"
            ],
            "Resource": "arn:aws:dynamodb:us-east-1:123456789012:table/users"
          }
        ]
      }

  - policyName: secretsmanager-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["secretsmanager:GetSecretValue"],
            "Resource": "arn:aws:secretsmanager:us-east-1:123456789012:secret:prod/*"
          }
        ]
      }

  # Limite máximo de permissões
  permissionsBoundary: arn:aws:iam::aws:policy/PowerUserAccess

  # Duração máxima da sessão: 12 horas
  maxSessionDuration: 43200

  # Tags para governança
  tags:
    Environment: production
    Team: platform
    CostCenter: engineering
    ManagedBy: infra-operator
```

## Status

Após aplicar a role, você pode verificar seu status:

```bash
kubectl describe iamrole lambda-execution-role
```

### Campos de Status

| Campo | Descrição |
|-------|-----------|
| `roleArn` | ARN completo da role criada |
| `roleId` | ID único da role no AWS IAM |
| `createDate` | Data de criação da role |
| `ready` | Booleano indicando se a role está pronta para uso |
| `conditions` | Detalhes de erros ou avisos |

Exemplo de status:

```yaml
status:
  roleArn: arn:aws:iam::123456789012:role/lambda-execution-role
  roleId: AIDAQ2EXAMPLE4DCDFG7
  createDate: "2025-11-22T10:30:00Z"
  ready: true
```

## Exemplos Práticos

### 1. Lambda Execution Role

Role para permitir que funções Lambda escrevam logs no CloudWatch:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: lambda-exec-role
spec:
  providerRef:
    name: production-aws
  roleName: lambda-execution-role
  description: "Role para execução de funções Lambda com CloudWatch logs"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "lambda.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  tags:
    Service: lambda
    Environment: production
```

### 2. EC2 Instance Profile Role

Role para instâncias EC2 com acesso a S3 e SSM:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: ec2-app-server-role
spec:
  providerRef:
    name: production-aws
  roleName: EC2-AppServer-Role
  description: "Role para servidores de aplicação EC2"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "ec2.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  inlinePolicies:
  - policyName: s3-app-bucket-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["s3:GetObject", "s3:ListBucket"],
            "Resource": [
              "arn:aws:s3:::my-app-bucket",
              "arn:aws:s3:::my-app-bucket/*"
            ]
          }
        ]
      }

  tags:
    Environment: production
    Type: ec2-instance
```

### 3. Cross-Account Access Role

Role para assumir acesso em outra conta AWS:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: cross-account-role
spec:
  providerRef:
    name: production-aws
  roleName: CrossAccount-Production-Access
  description: "Role para acesso cross-account da conta de desenvolvimento"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {
          "AWS": "arn:aws:iam::111111111111:root"
        },
        "Action": "sts:AssumeRole",
        "Condition": {
          "StringEquals": {"sts:ExternalId": "unique-external-id-123"}
        }
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/ReadOnlyAccess

  maxSessionDuration: 28800  # 8 horas

  tags:
    Purpose: cross-account-access
    SourceAccount: "111111111111"
```

### 4. Service Role para ECS

Role para tarefas ECS com acesso a ECR e SecretsManager:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: ecs-task-role
spec:
  providerRef:
    name: production-aws
  roleName: ecsTaskExecutionRole
  description: "Role para execução de tarefas ECS"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "ecs-tasks.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  inlinePolicies:
  - policyName: ecr-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "ecr:GetAuthorizationToken",
              "ecr:BatchGetImage",
              "ecr:GetDownloadUrlForLayer"
            ],
            "Resource": "*"
          }
        ]
      }

  - policyName: secrets-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["secretsmanager:GetSecretValue"],
            "Resource": "arn:aws:secretsmanager:us-east-1:123456789012:secret:ecs/*"
          }
        ]
      }

  tags:
    Service: ecs
    Environment: production
```

### 5. Role com Permissions Boundary

Role com limite de permissões para garantir conformidade:

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: developer-role
spec:
  providerRef:
    name: production-aws
  roleName: Developer-Boundary-Role
  description: "Role para desenvolvedores com permissions boundary"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {
          "AWS": "arn:aws:iam::123456789012:root"
        },
        "Action": "sts:AssumeRole"
      }]
    }

  # A role pode ter estas permissões
  managedPolicyArns:
  - arn:aws:iam::aws:policy/PowerUserAccess

  # Mas está limitada por este boundary
  permissionsBoundary: arn:aws:iam::123456789012:policy/DeveloperBoundaryPolicy

  tags:
    Type: developer
    Environment: development
```

### 6. Role para IRSA (EKS ServiceAccount)

Role para integração com EKS Service Accounts (IRSA):

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: eks-app-role
spec:
  providerRef:
    name: production-aws
  roleName: EKS-App-ServiceAccount-Role
  description: "Role para pods em EKS via IRSA"

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {
          "Federated": "arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/ABC123"
        },
        "Action": "sts:AssumeRoleWithWebIdentity",
        "Condition": {
          "StringEquals": {
            "oidc.eks.us-east-1.amazonaws.com/id/ABC123:sub": "system:serviceaccount:default:app-sa"
          }
        }
      }]
    }

  inlinePolicies:
  - policyName: s3-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["s3:*"],
            "Resource": "arn:aws:s3:::eks-app-data/*"
          }
        ]
      }

  tags:
    Cluster: production-eks
    Purpose: irsa
```

## Verificação e Testes

### Verificar Role Criada

```bash
# Listar todas as roles
kubectl get iamroles

# Detalhes da role
kubectl describe iamrole lambda-execution-role

# Obter ARN da role
kubectl get iamrole lambda-execution-role -o jsonpath='{.status.roleArn}'

# Ver política de confiança
kubectl get iamrole lambda-execution-role -o yaml | grep -A 50 assumeRolePolicy
```

### Testar Assume Role com AWS CLI

```bash
# Assumir a role do seu usuário AWS
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/lambda-execution-role \
  --role-session-name test-session

# Usar as credenciais retornadas para fazer requisições
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=...

# Verificar identidade assumida
aws sts get-caller-identity
```

### Validar Permissões

```bash
# Listar permissões da role
aws iam get-role --role-name lambda-execution-role

# Listar políticas anexadas
aws iam list-attached-role-policies --role-name lambda-execution-role

# Listar políticas inline
aws iam list-role-policies --role-name lambda-execution-role

# Ver política inline específica
aws iam get-role-policy \
  --role-name lambda-execution-role \
  --policy-name dynamodb-access
```

## Troubleshooting

### Error: "Access Denied" ao Criar Role

**Problema**: O operador não tem permissão para criar roles.

**Solução**:
1. Verifique as permissões IAM do usuário/role do operador
2. O operador precisa de `iam:CreateRole`, `iam:AttachRolePolicy`, `iam:PutRolePolicy`
3. Verifique se a política de confiança está correta no AWSProvider

```bash
# Verificar credenciais
aws sts get-caller-identity

# Verificar permissões de teste
aws iam list-roles --max-items 1
```

### Error: "Invalid Trust Relationship"

**Problema**: O `assumeRolePolicyDocument` tem syntax inválida.

**Solução**:
1. Valide o JSON usando `python3 -m json.tool`
2. Certifique-se que a sintaxe das principais é correta
3. Verifique se os ARNs existem realmente

```yaml
# Correto ✅
assumeRolePolicyDocument: |
  {
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Principal": {"Service": "lambda.amazonaws.com"},
      "Action": "sts:AssumeRole"
    }]
  }

# Incorreto ❌
assumeRolePolicyDocument: '{
  "Version": "2012-10-17",
  # Comentários não são permitidos em JSON
}'
```

### Error: "Policy Too Permissive"

**Problema**: A política permite mais do que o esperado.

**Solução**:
1. Revise cada statement da política
2. Use Resources específicas ao invés de "*"
3. Use Conditions para restringir access
4. Implemente Permissions Boundary

```yaml
# Melhorado ✅
inlinePolicies:
- policyName: s3-limited-access
  policyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Action": ["s3:GetObject", "s3:ListBucket"],
        "Resource": "arn:aws:s3:::my-bucket/*",
        "Condition": {
          "IpAddress": {
            "aws:SourceIp": ["10.0.0.0/8"]
          }
        }
      }]
    }
```

### Error: "Circular Dependency"

**Problema**: Role A assume Role B que assume Role A.

**Solução**:
1. Revise a hierarquia de roles
2. Use External IDs para evitar confusão
3. Considere um desenho diferente de assumeRole

### Error: "Session Duration Exceeded"

**Problema**: `maxSessionDuration` é menor que necessário.

**Solução**:
1. Aumente o valor (máximo: 43200 segundos = 12 horas)
2. Verifique se a aplicação realmente precisa de sessões longas

```yaml
# Mínimo: 900 (15 min)
# Máximo: 43200 (12 horas)
maxSessionDuration: 28800  # 8 horas
```

## Melhores Práticas

### 1. Princípio do Menor Privilégio

Sempre use permissões mínimas necessárias:

```yaml
# Correto ✅
inlinePolicies:
- policyName: specific-access
  policyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Action": ["s3:GetObject"],
        "Resource": "arn:aws:s3:::my-bucket/public/*"
      }]
    }

# Evitar ❌
inlinePolicies:
- policyName: all-access
  policyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Action": ["*"],
        "Resource": "*"
      }]
    }
```

### 2. Use Managed Policies para Padrões Comuns

```yaml
# Prefira políticas gerenciadas
managedPolicyArns:
- arn:aws:iam::aws:policy/AWSLambdaBasicExecutionRole

# Para comportamentos customizados, use inline policies
inlinePolicies:
- policyName: custom-logic
  policyDocument: |
    { ... }
```

### 3. Implemente Permissions Boundary

Sempre use permissions boundary em roles assumíveis:

```yaml
permissionsBoundary: arn:aws:iam::aws:policy/PowerUserAccess
```

### 4. Use Tags para Governança

```yaml
tags:
  Environment: production
  Team: platform
  CostCenter: engineering
  ManagedBy: infra-operator
  Rotation: quarterly
```

### 5. Revise e Audite Regularmente

```bash
# Usar IAM Access Analyzer
aws accessanalyzer validate-policy --policy-document file://policy.json

# Listar todas as roles gerenciadas
kubectl get iamroles -A

# Auditar logs no CloudTrail
aws cloudtrail lookup-events --lookup-attributes AttributeKey=ResourceName,AttributeValue=my-role
```

### 6. MFA para Roles Sensíveis

```yaml
assumeRolePolicyDocument: |
  {
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:root"},
      "Action": "sts:AssumeRole",
      "Condition": {
        "Bool": {"aws:MultiFactorAuthPresent": "true"}
      }
    }]
  }
```

### 7. Rotation Policies

Documente quando as roles foram criadas e sua data de próxima revisão:

```yaml
tags:
  CreatedDate: "2025-11-22"
  NextReviewDate: "2026-02-22"
  RotationInterval: "quarterly"
```

### 8. Service Control Policies (SCP)

Combine com SCPs para máxima segurança:

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Deny",
    "Action": [
      "iam:DeleteRole",
      "iam:DeleteRolePolicy",
      "iam:PutUserPermissionsBoundary"
    ],
    "Resource": "*"
  }]
}
```

## Padrões Comuns

### Lambda com Acesso a S3 e DynamoDB

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: lambda-data-processor
spec:
  providerRef:
    name: production-aws
  roleName: lambda-data-processor

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "lambda.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  inlinePolicies:
  - policyName: data-access
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["s3:GetObject", "s3:PutObject"],
            "Resource": "arn:aws:s3:::data-bucket/*"
          },
          {
            "Effect": "Allow",
            "Action": [
              "dynamodb:GetItem",
              "dynamodb:PutItem",
              "dynamodb:Query"
            ],
            "Resource": "arn:aws:dynamodb:us-east-1:*:table/data"
          }
        ]
      }
```

### EC2 com Acesso a Múltiplos Serviços

```yaml
apiVersion: infra.operator.aws.io/v1alpha1
kind: IAMRole
metadata:
  name: ec2-application-role
spec:
  providerRef:
    name: production-aws
  roleName: EC2-Application-Role

  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "ec2.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }

  managedPolicyArns:
  - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
  - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly

  inlinePolicies:
  - policyName: s3-and-dynamodb
    policyDocument: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": ["s3:*"],
            "Resource": "arn:aws:s3:::app-bucket/*"
          },
          {
            "Effect": "Allow",
            "Action": ["dynamodb:*"],
            "Resource": "arn:aws:dynamodb:*:*:table/app-*"
          },
          {
            "Effect": "Allow",
            "Action": ["secretsmanager:GetSecretValue"],
            "Resource": "arn:aws:secretsmanager:*:*:secret:app/*"
          }
        ]
      }
```

## Recursos Relacionados

### Documentação AWS
- [IAM Roles Documentation](https://docs.aws.amazon.com/iam/latest/userguide/id_roles.html)
- [Trust Relationships](https://docs.aws.amazon.com/iam/latest/userguide/id_roles_create_for-user.html)
- [Permissions Boundary](https://docs.aws.amazon.com/iam/latest/userguide/access_policies_boundaries.html)
- [Policy Simulator](https://policysim.aws.amazon.com/)

### Ferramentas Úteis
- [IAM Policy Generator](https://awspolicygen.s3.amazonaws.com/policygen.html)
- [IAM Access Analyzer](https://aws.amazon.com/iam/access-analyzer/)
- [Policy Validator](https://docs.aws.amazon.com/IAM/latest/UserGuide/access-analyzer-policy-validation.html)

### Integração com Infra Operator
- [EC2 Instance - Role Profile](/services/compute/ec2)
- [Lambda Function - Execution Role](/services/compute/lambda)
- [ECS Task - Execution Role](/services/compute/ecs)
- [Secrets Manager - Role Access](/services/security/secretsmanager)

---
