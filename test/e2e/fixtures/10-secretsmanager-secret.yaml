---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: secretsmanagersecrets.aws-infra-operator.runner.codes
spec:
  group: aws-infra-operator.runner.codes
  names:
    kind: SecretsManagerSecret
    listKind: SecretsManagerSecretList
    plural: secretsmanagersecrets
    singular: secretsmanagersecret
    shortNames:
    - smsecret
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - providerRef
            - secretName
            properties:
              providerRef:
                type: object
                required:
                - name
                properties:
                  name:
                    type: string
                  namespace:
                    type: string
              secretName:
                type: string
              description:
                type: string
              secretStringRef:
                type: object
                required:
                - name
                - key
                properties:
                  name:
                    type: string
                  key:
                    type: string
              secretBinaryRef:
                type: object
                properties:
                  name:
                    type: string
                  key:
                    type: string
              kmsKeyId:
                type: string
              rotationEnabled:
                type: boolean
                default: false
              rotationLambdaARN:
                type: string
              automaticallyAfterDays:
                type: integer
                minimum: 1
              tags:
                type: object
                additionalProperties:
                  type: string
              deletionPolicy:
                type: string
                enum:
                - Delete
                - Retain
                default: Delete
              recoveryWindowInDays:
                type: integer
                minimum: 0
                maximum: 30
                default: 30
          status:
            type: object
            properties:
              ready:
                type: boolean
              arn:
                type: string
              versionId:
                type: string
              createdDate:
                type: string
                format: date-time
              lastChangedDate:
                type: string
                format: date-time
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    reason:
                      type: string
                    message:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Secret
      type: string
      jsonPath: .spec.secretName
    - name: ARN
      type: string
      jsonPath: .status.arn
    - name: Ready
      type: boolean
      jsonPath: .status.ready
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp

---
# Kubernetes Secret containing the actual secret value
apiVersion: v1
kind: Secret
metadata:
  name: db-password-source
  namespace: default
type: Opaque
stringData:
  password: "MyS3cr3tP@ssw0rd123!"

---
# Test Secrets Manager Secret 1: Database password
apiVersion: aws-infra-operator.runner.codes/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: e2e-db-password
  namespace: default
spec:
  providerRef:
    name: localstack
  secretName: e2e/db/password
  description: "Database password for E2E testing"
  secretStringRef:
    name: db-password-source
    key: password
  tags:
    environment: test
    managed-by: infra-operator
    purpose: e2e-testing
  deletionPolicy: Delete
  recoveryWindowInDays: 7

---
# Kubernetes Secret for API key
apiVersion: v1
kind: Secret
metadata:
  name: api-key-source
  namespace: default
type: Opaque
stringData:
  apikey: "sk-1234567890abcdefghijklmnopqrstuvwxyz"

---
# Test Secrets Manager Secret 2: API Key with immediate deletion
apiVersion: aws-infra-operator.runner.codes/v1alpha1
kind: SecretsManagerSecret
metadata:
  name: e2e-api-key
  namespace: default
spec:
  providerRef:
    name: localstack
  secretName: e2e/api/key
  description: "API key for external service - E2E testing"
  secretStringRef:
    name: api-key-source
    key: apikey
  tags:
    environment: test
    managed-by: infra-operator
    service: api
    purpose: e2e-testing
  deletionPolicy: Delete
  recoveryWindowInDays: 0
